# 小さなボタンを作る

本ドキュメントは [Ansible Trail Map 牡丹山](https://www.redhat.com/ja/explore/ansible/trailmap) の一部となります。
構築した Red Hat Ansible Automation Platform で小さなボタンを作る方法について解説していきます。

## 作成の流れ

1. [準備するもの](#準備するもの)
1. [ボタンを構成する要素](#ボタンを構成する要素)
1. [プロジェクトの作成](#プロジェクトの作成)
1. [クレデンシャルの作成](#クレデンシャルの作成)
1. [インベントリーの作成](#インベントリーの作成)
1. [ジョブテンプレートの作成](#ジョブテンプレートの作成)
1. [実行時に変数を入力させる方法](#実行時に変数を入力させる方法)

## 準備するもの

本ステップを進める上で必要な環境は以下となります。

1. Red Hat Ansible Automation Platform 環境(step4 で準備)
2. ボタン化したいPlaybook
3. 自動化の対象となるテスト環境(サーバーやネットワーク機器)

>Note: 2については git 環境で管理されているとベストです。また git を使っていない場合はファイルとして Playbook を利用することも可能ですが、ぜひこれを機に git の利用を検討してください。

## ボタンを構成する要素

Red Hat Ansible Automation Platform ではボタンを構成するためには以下の3つを事前に設定する必要があります。

- Project（プロジェクト）・・・利用するPlaybookを登録する
- Inventory（インベントリー）・・・自動化の対象となるホストを登録する
- Credential（クレデンシャル）・・・認証情報を登録する

まずはこれらを Red Hat Ansible Automation Platform 上で作成していきます。

## プロジェクトの作成
プロジェクトには使用するPlaybookを登録します。大きく2つの方法があり「外部SCMと連携する」か「手動でファイルを登録する」になります。外部のSCMとの連携が最も一般的で、多くの場合で git が利用されます。ここでは git を例に手順を紹介し、最後に手動でのファイル登録を紹介します。

>Note: ここで使用するPlaybookは、`play` において `hosts: all` へと設定してください。`all` 以外の設定でもインベントリー側で名前を合わせれば問題なく動きます。しかしこの「Play」と「インベントリー」の一致を人が調整するのは手間がかかります。そのためTowerでは「Playはall」で統一し、インベントリーとジョブテンプレートの「Limit」で実行対象を絞るという使い方が推奨です。

### プロジェクトの追加
左メニューから「プロジェクト」を選択し、画面右側の「＋」ボタンを押すことでプロジェクトの追加が行えます。
<img src="./images/step5/project-create1.png" width=50%>

### git 連携によるプロジェクト作成
git 連携を行う場合は、利用するPlaybookが git 上のリポジトリに格納されていることが前提となります。

#### git プロジェクトの作成
「名前」と「説明」を入力し、「SCMライプ」で「git」を選択するとリポジトリのURL入力のフォームが表示されます。ここに自分のリポジトリのURLを入力します。「SCMの更新オプション」にはサンプルのようにチェックを入れます。このオプションはTowerサーバー上にキャッシュされるリポジトリのデータを毎回クリーンな状態に保つます。最初はトラブルを避けるためにこのチェックを入れるのがお薦めです。
最後に「保存」を押すと設定が保存され、リポジトリの同期が行われます。

<img src="./images/step5/project-git1.png" width=50%>

>Note: リポジトリのアクセスに認証が必要な場合は、先にリポジトリの認証情報を登録しておき、その認証情報を「SCM認証情報」にセットします。認証情報の作成は後述する「クレデンシャルの作成」を確認してください。

#### 同期の確認
プロジェクトを作成すると初回の同期が自動で開始されます。プロジェクトの横に緑マークがつけば同期に成功し、Playbookが利用可能な状態になります。

<img src="./images/step5/project-git2.png" width=50%>

>Note: 同期がエラーとなった場合の対処。設定ミスや認証設定の問題でエラーとなる場合があります。その場合は左メニューの「ジョブ」からログを確認することが可能です。ここからエラーの原因を確認してください。

<img src="./images/step5/project-git3.png" width=50%>


### 手動でファイルを登録してプロジェクト作成
git 等のSCMを使用しない場合は、手動でTowerサーバー上にPlaybookをアップロードして利用することが可能です。

#### ファイルをTowerサーバーへアップロード
まずTowerサーバーへファイルをアップロードします。

操作はAWXユーザーで行います。このユーザーはTowerのインストール時に自動的に作成されます。
```bash
[root@localhost ~]# su - awx

[awx@localhost ~]$ pwd
/var/lib/awx
```

Playbookは `/var/lib/awx/projects` にディレクトリを作成して格納します。
```bash
[awx@localhost ~]$ cd projects/
[awx@localhost projects]$ mkdir my_project
[awx@localhost projects]$ cd my_project/

[awx@localhost my_project]$ pwd
/var/lib/awx/projects/my_project

[awx@localhost my_project]$ cp my_playbook.yml .
```

>Note: 権限の設定
このとき、ディレクトリとPlaybookの権限は `awx:awx` に設定されている必要があります。root ユーザー等で操作したときは注意してください。
```
[awx@localhost ~]$ chown -R awx:awx ~/projects/my_project
```

#### ディレクトリをプロジェクトへ登録
PlaybookをアップロードしたディレクトリをTowerへ登録します。プロジェクトの作成からSCMタイプ「手動」を選択し、Playbookのディレクトリを選択して保存します。

<img src="./images/step5/project-manual1.png" width=50%>


## クレデンシャルの作成
クレデンシャルには様々な認証情報を登録します。登録された認証情報を使ってTowerは自動化の対象となる環境へログインを行います。ここに登録された認証情報のパスワードは登録した人でも内容を確認することができません。つまり、ユーザー名やパスワードを利用者や開発者に教えることなく自動化の開発や実行が行えるようになります。

### クレデンシャルの登録
左メニューから「認証情報」を選択し、右側の「＋」ボタンからクレデンシャルの登録を行います。
<img src="./images/step5/cred1.png" width=50%>

### クレデンシャル情報
「名前」を入力し、このクレデンシャルを使用する「組織」を選択します。ここでは「Default」を選択します。

そして「認証情報タイプ」から自動化の対象の種別を選びます。これはサーバーOSやネットワーク、クラウド環境ごとに認証に必要な情報が異なるためです。よく使うタイプは以下です。自分の環境に合わせて選択してください。

- マシン ・・・一般的なLinuxサーバーで使用します。
- ネットワーク ・・・CiscoやJuniper, Arista等のネットワーク機器で使用します。

以下では「マシン」を選んだ場合の設定を紹介します。

<img src="./images/step5/cred2.png" width=50%>

「マシン」を選択した場合には「ユーザー名」と「パスワード」を入力します。パスワードの代わりに「SSH秘密鍵」を設定することも可能です。こちらも自分の環境に合わせて設定してください。

入力したら画面下側の「保存」を押すのを忘れないでください。これでクレデンシャルの設定は終わりです。

> Note: git リポジトリへのアクセスに認証が必要な場合は、ここで認証タイプの「GitHub(GitLab) パーソナルアクセストークン」を使って認証情報を設定し、プロジェクト作成時に割り当ててください。

## インベントリーの作成
ここでは自動化の対象を設定する「インベントリー」を作成していきます。コマンドラインで使用していた時のインベントリーファイルと同じ役割です。ここでは手動で作成する手順を解説しますが、ファイルからインポートしたり、ダイナミックインベントリーの使用も可能です。

### インベントリーの追加
まず左メニューの「インベントリー」を選択し、「＋」ボタンを押します。すると選択肢が表示されるので「インベントリー」を選択します。

<img src="./images/step5/inv1.png" width=50%>

### インベントリーの概要を設定
最初の画面ではまずインベントリーに「名前」をつけます。名前を入力したら「保存」してください。
インベントリー全体に適用したい変数がある場合には「変数」のところに入力します。

<img src="./images/step5/inv2.png" width=50%>

### ホストの追加
次にインベントリー画面の上側の「ホスト」を選択してホストを追加していきます。「＋」からホストを追加します。

<img src="./images/step5/inv3.png" width=50%>


ホスト名と必要なホスト変数を入力して「保存」します。

<img src="./images/step5/inv4.png" width=50%>


更にホストの追加を行う場合は、画面下側の「＋」から追加してください。

<img src="./images/step5/inv5.png" width=50%>

### グループの作成
必要に応じてグループを追加します。グループが不要の場合は飛ばしても問題ありません。


作成したインベントリーの「グループ」を選択し、「＋」ボタンからグループを追加します。

<img src="./images/step5/inv6.png" width=50%>


グループの名前と、適用するグループ変数があればここで設定します。入力が終わったら「保存」します。

<img src="./images/step5/inv7.png" width=50%>


グループにホストを追加します。グループメニューの「ホスト」ボタンを選択し、「＋」ボタンから「既存ホスト」を選択します。

<img src="./images/step5/inv8.png" width=50%>


追加するホストを選択し「保存」します。

<img src="./images/step5/inv9.png" width=50%>


追加するとインベントリーの「ホスト」メニューから所属するグループが確認できます。

<img src="./images/step5/inv10.png" width=50%>


これでインベントリーの作成は終了です。


## ジョブテンプレートの作成

## 実行時に変数を入力させる方法




